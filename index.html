<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GitHub Raw Python Viewer</title>

  <!-- highlight.js -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    body {
      margin: 0;
      background: #0d1117;
      color: #c9d1d9;
      font-family: monospace;
    }
    pre {
      margin: 0;
      padding: 16px;
      overflow: auto;
    }
  </style>
</head>
<body>

<pre><code id="code" class="language-python"></code></pre>

<script>
/* ===============================
   Read query parameters
================================ */

const params = new URLSearchParams(location.search);

const repo   = params.get("repo");   // owner/repo
const commit = params.get("commit"); // hash or branch
const path   = params.get("path");   // file path

if (!repo || !commit || !path) {
  document.body.textContent =
    "Missing query parameters: repo, commit, path";
  throw new Error("Missing parameters");
}

/* ===============================
   GitHub raw fetch + cache
================================ */

const RAW_BASE = "https://raw.githubusercontent.com";
const cache = new Map();

async function fetchRaw(path) {
  const url = `${RAW_BASE}/${repo}/${commit}/${path}`;
  if (cache.has(url)) return cache.get(url);

  const res = await fetch(url);
  if (!res.ok) throw new Error(`404: ${url}`);

  const text = await res.text();
  cache.set(url, text);
  return text;
}

/* ===============================
   Method 1: Load & highlight
================================ */

async function loadMainFile() {
  const code = await fetchRaw(path);
  const el = document.getElementById("code");
  el.textContent = code;
  hljs.highlightElement(el);
  return code;
}

/* ===============================
   Method 2: Import analysis
================================ */

function extractPythonImports(code) {
  const imports = new Set();

  for (const line of code.split("\n")) {
    let m;

    // import a.b.c
    m = line.match(/^\s*import\s+([a-zA-Z0-9_.]+)/);
    if (m) imports.add(m[1]);

    // from a.b import c
    m = line.match(/^\s*from\s+([a-zA-Z0-9_.]+)\s+import\s+/);
    if (m) imports.add(m[1]);
  }
  return [...imports];
}

function resolveImport(importName, currentPath) {
  const baseDir = currentPath.split("/").slice(0, -1).join("/");
  const rel = importName.replace(/\./g, "/");

  return [
    `${rel}.py`,
    `${rel}/__init__.py`,
    `${baseDir}/${rel}.py`,
    `${baseDir}/${rel}/__init__.py`
  ];
}

async function preloadImports(mainCode) {
  const imports = extractPythonImports(mainCode);

  for (const imp of imports) {
    const candidates = resolveImport(imp, path);
    for (const p of candidates) {
      try {
        await fetchRaw(p);
        console.log("Loaded import:", p);
        break;
      } catch {
        /* ignore */
      }
    }
  }
}

/* ===============================
   Bootstrap
================================ */

(async () => {
  try {
    const mainCode = await loadMainFile();
    await preloadImports(mainCode);
    console.log("Cached files:", cache);
  } catch (e) {
    console.error(e);
  }
})();
</script>

</body>
</html>
